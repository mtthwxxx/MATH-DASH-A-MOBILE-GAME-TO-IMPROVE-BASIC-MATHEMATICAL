<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1117">
    <meta name="description" content="Master the Basic Operations & Integers - A fun math racing game!">
    
    <title>MRace: Math Dash</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Game Aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Chivo+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Chivo Mono', monospace;
            background-color: #0d1117; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #e6e6fa;
            padding: 10px;
            margin: 0;
        }

        .game-container {
            width: 100%;
            max-width: 450px; 
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Responsive adjustments for smaller screens */
        @media screen and (max-width: 400px) {
            .game-container {
                padding: 8px;
                gap: 8px;
            }
            
            body {
                padding: 5px;
            }
        }

        /* Responsive adjustments for larger tablets */
        @media screen and (min-width: 600px) {
            .game-container {
                max-width: 500px;
            }
        }

        /* Landscape mode adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            body {
                min-height: auto;
                padding: 5px;
            }
            
            .game-container {
                padding: 8px;
                gap: 8px;
            }
        }
        
        .game-title {
            font-family: 'Luckiest Guy', cursive;
            text-shadow: 2px 2px 0 #0d1117, -2px -2px 0 #0d1117, 2px -2px 0 #0d1117, -2px 2px 0 #0d1117;
            letter-spacing: 2px;
            font-size: clamp(2rem, 8vw, 2.5rem);
        }

        .mode-button {
            font-family: 'Luckiest Guy', cursive;
            background-color: #58a6ff; 
            color: #0d1117; 
            padding: clamp(15px, 4vw, 20px) clamp(12px, 3vw, 15px); 
            border-radius: 8px; 
            font-size: clamp(1.2rem, 4vw, 1.6rem); 
            text-align: center;
            transition: transform 0.1s;
            cursor: pointer;
            margin: 5px;
            
            clip-path: polygon(
                50% 0%, 60% 5%, 70% 0%, 80% 5%, 90% 0%, 100% 5%, 95% 40%, 100% 70%, 90% 95%, 80% 90%, 70% 100%, 60% 95%, 50% 100%, 40% 95%, 30% 100%, 20% 95%, 10% 100%, 0% 95%, 5% 60%, 0% 30%, 10% 5%, 20% 10%, 30% 0%, 40% 5%
            );
            
            border: 4px solid #ffffff; 
            box-shadow: 
                0 0 0 8px rgba(9, 30, 66, 0.4), 
                0 8px 0 #2b8438, 
                0 10px 15px rgba(0, 0, 0, 0.5); 
        }

        @media screen and (max-width: 350px) {
            .mode-button {
                font-size: 1.1rem;
                padding: 12px 10px;
            }
        }

        .mode-button:active {
            transform: translateY(4px); 
            box-shadow: 
                0 0 0 8px rgba(9, 30, 66, 0.4),
                0 4px 0 #2b8438, 
                0 5px 10px rgba(0, 0, 0, 0.5);
        }

        .mode-button.bg-red-500 {
            background-color: #f85149; 
        }
        .mode-button.bg-red-500:active {
            box-shadow: 
                0 0 0 8px rgba(9, 30, 66, 0.4),
                0 4px 0 #7c2d12, 
                0 5px 10px rgba(0, 0, 0, 0.5);
        }
        
        .player-id-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 6px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .player-id-container:hover {
            background-color: rgba(88, 166, 255, 0.2);
        }
        
        .copy-icon {
            width: 16px;
            height: 16px;
            color: #58a6ff;
            cursor: pointer;
        }

        .auto-detected {
            border-color: #3fb950 !important;
            background-color: rgba(63, 185, 80, 0.1) !important;
        }

        #homeScreen {
            background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
            border-radius: 8px;
            padding: clamp(15px, 4vw, 20px); 
        }
        
        #homeButtonBox {
            border: 4px solid #f85149; 
            padding: clamp(15px, 4vw, 20px);
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 3vw, 15px);
            align-items: center;
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(248, 81, 73, 0.5); 
        }

        .quit-button {
            background-color: #f85149;
            color: white;
            padding: clamp(6px, 2vw, 8px);
            border-radius: 8px;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            font-weight: bold;
            box-shadow: 0 4px #b33833;
            transition: transform 0.1s;
        }
        .quit-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #b33833;
        }

        .leaderboard-item {
            display: grid;
            grid-template-columns: 1fr 3fr 2fr;
            padding: 4px 8px;
            border-bottom: 1px solid #30363d;
            font-size: clamp(0.75rem, 2vw, 0.875rem);
        }

        .leaderboard-filter-active {
            background-color: #58a6ff !important;
            color: #0d1117 !important;
        }

        /* Make filter buttons responsive */
        .leaderboard-filter-btn {
            font-size: clamp(0.7rem, 2vw, 0.875rem);
            padding: clamp(4px, 1.5vw, 8px) clamp(8px, 2vw, 12px);
        }

        /* Responsive stat labels and values */
        .stat-label {
            font-size: clamp(0.65rem, 1.8vw, 0.75rem);
        }

        .stat-value {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        }
    </style>
</head>
<body>

<div class="game-container">
    
    <div class="text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400 game-title">MRace</h1>
    </div>
    
    <div id="homeScreen" class="flex flex-col gap-4 items-center text-center">
        
        <div id="homeHeader">
            <p class="stat-label mb-2" style="font-size: clamp(0.65rem, 2vw, 0.75rem);">Master the Basic Operations & Integers</p>
            <img src="./MRace/file_00000000ae447206a4e2d6c246c95810-removebg-preview.png" alt="MRace Logo" class="w-full max-w-[100px] sm:max-w-[120px] h-auto mx-auto">
        </div>

        <div id="homeButtonBox">
            <img id="playButton" src="./MRace/received_1196488405728233-removebg-preview.png" alt="Play Button" class="w-3/5 max-w-[130px] sm:max-w-[150px] h-auto cursor-pointer transition-transform duration-100 active:scale-95">

            <button id="quitButton" class="quit-button w-4/5 max-w-[220px] sm:max-w-[250px] mt-2 sm:mt-3">
                QUIT GAME
            </button>
        </div>
    </div>

    <div id="userInputScreen" class="hidden py-6 flex-col gap-4 text-center">
        
        <div id="playerInfoHeader">
            <p class="text-gray-300 font-semibold">Enter Your Information:</p>
            
            <div class="player-id-container text-xs stat-label mt-1" id="userIdContainer" title="Click to copy your Firebase ID">
                Player ID: 
                <span id="userIdDisplay" class="font-semibold text-gray-300">Loading...</span>
                <span id="copyFeedback" class="text-green-500 text-xs hidden">Copied!</span>
                <svg class="copy-icon" id="copyIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                    <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" />
                </svg>
            </div>
        </div>

        <div class="flex flex-col gap-2 text-left">
            <label class="stat-label">Surname:</label>
            <input type="text" id="surnameInput" placeholder="Enter Surname (e.g., Dela Cruz)" 
                    class="rounded p-2 sm:p-3 text-base sm:text-lg bg-gray-800 border border-yellow-400 text-yellow-400 gap-2" 
                    maxlength="20">
        </div>

        <div class="flex flex-col gap-2 text-left mb-6">
            <label class="stat-label">Year and Section:</label>
            <select id="yearSectionSelect" 
                    class="rounded p-2 sm:p-3 text-base sm:text-lg bg-gray-800 border border-yellow-400 text-yellow-400"
                    disabled>
                <option value="">-- Enter Surname First --</option>
                <option value="7 - STE">7 - STE</option>
                <option value="7 - Python">7 - Python</option>
                <option value="7 - Twinkl">7 - Twinkl</option>
                <option value="7 - Sampaguita">7 - Sampaguita</option>
                <option value="7 - Camia">7 - Camia</option>
                <option value="7 - Ilang-ilang">7 - Ilang-ilang</option>
                <option value="7 - Daisy">7 - Daisy</option>
                <option value="7 - Dahlia">7 - Dahlia</option>
                <option value="7 - Gumamela">7 - Gumamela</option>
                <option value="7 - Sunflower">7 - Sunflower</option>
                <option value="7 - Santan">7 - Santan</option>
                <option value="7 - Lilac">7 - Lilac</option>
                <option value="7 - Tulip">7 - Tulip</option>
            </select>
        </div>
      
        
        <button id="signInButton" class="w-full py-2 sm:py-3 bg-yellow-400 text-gray-900 font-extrabold rounded-lg shadow-lg text-base sm:text-lg" 
            style="font-family: 'Luckiest Guy', cursive; box-shadow: 0 4px #d4a71c;" disabled>
            START RACING
        </button>
        
        <button id="backToHomeButton" class="w-full py-2 sm:py-3 bg-yellow-400 text-black font-bold rounded-lg shadow-lg text-base sm:text-lg hover:bg-gray-700 transition-colors mt-3" 
            style="font-family: 'Luckiest Guy', cursive; box-shadow: 0 4px #d4a71c">
            ← BACK TO HOME
        </button>
        
        <p id="authMessage" class="stat-label h-4 mt-2">Firebase Ready</p>
    </div>

    <div id="gameScreen" class="hidden">
        <div class="flex justify-between p-2 rounded bg-gray-800/50 text-xs sm:text-sm font-semibold">
            <div class="flex flex-col items-center">
                <span class="stat-label">TIME</span>
                <span id="time" class="stat-value">60s</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="stat-label">SCORE</span>
                <span id="score" class="stat-value text-green-400">0</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="stat-label">DISTANCE</span>
                <span id="distance" class="stat-value">0 m</span>
            </div>
        </div>
    
        <div id="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
        </div>
    
        <div class="text-center p-2 sm:p-3 rounded bg-gray-800 border-b-4 border-yellow-400">
            <div id="questionDisplay" class="text-2xl sm:text-3xl font-bold text-white mb-2">
                Tap START
            </div>
            <div id="feedback" class="h-6 text-base sm:text-lg font-semibold correct-message"></div>
        </div>
    
        <div class="flex flex-col gap-2">
            <input type="text" id="answerInput" placeholder="Answer" class="rounded p-2" readonly>
            <div id="keypad" class="grid grid-cols-4 gap-2">
                <button class="keypad-button" data-key="7">7</button>
                <button class="keypad-button" data-key="8">8</button>
                <button class="keypad-button" data-key="9">9</button>
                <button class="keypad-button action-button" data-key="backspace">←</button>

                <button class="keypad-button" data-key="4">4</button>
                <button class="keypad-button" data-key="5">5</button>
                <button class="keypad-button" data-key="6">6</button>
                <button class="keypad-button action-button" data-key="sign">+/-</button>

                <button class="keypad-button" data-key="1">1</button>
                <button class="keypad-button" data-key="2">2</button>
                <button class="keypad-button" data-key="3">3</button>
                <button id="submitButton" class="keypad-button action-button col-span-1 row-span-2" data-key="submit" style="background-color: #3fb950; box-shadow: 0 4px #2b8438;">
                    START
                </button>

                <button class="keypad-button col-span-2" data-key="0">0</button>
                <button class="keypad-button" data-key="." data-disabled="true" style="opacity: 0.5;">.</button>
            </div>
        </div>
    </div>
    
    <div id="menuScreen" class="hidden flex-col gap-3 py-4">
        <h2 class="text-lg sm:text-xl font-bold text-blue-400 text-center">SELECT MODE</h2>
        <button class="mode-button" data-mode="ADDITION">ADDITION</button>
        <button class="mode-button" data-mode="SUBTRACTION">SUBTRACTION</button>
        <button class="mode-button" data-mode="MULTIPLICATION">MULTIPLICATION</button>
        <button class="mode-button" data-mode="DIVISION">DIVISION</button>
        <button class="mode-button bg-red-500 border-white" data-mode="INTEGERS">
            INTEGERS (Mixed)
        </button>
    </div>

    <div id="gameOverModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center p-4 z-10">
        <div class="bg-gray-700 p-6 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-3xl font-extrabold text-red-500 mb-4">GAME OVER!</h2>
            <p class="text-lg text-gray-200 mb-2">Score saved!</p>
            <p class="text-xl font-bold text-yellow-400 mb-4">Final Score: <span id="finalScore">0</span></p>
            <p class="text-md text-gray-300 mb-6">Distance Traveled: <span id="finalDistance">0 m</span></p>
            <button id="restartButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                PLAY AGAIN
            </button>
            <button id="backToMenuButton" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                MAIN MENU
            </button>
        </div>
    </div>

    <div id="leaderboardSection" class="hidden mt-4 p-3 rounded bg-gray-800/50">
        <div class="flex flex-wrap justify-center gap-2 mb-3 bg-gray-700 p-2 rounded">
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="OVERALL">Overall</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="MY_SECTION">My Section</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="ADDITION">Addition</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="SUBTRACTION">Subtraction</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="MULTIPLICATION">Multiplication</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="DIVISION">Division</button>
            <button class="leaderboard-filter-btn px-3 py-1 rounded text-sm bg-gray-800 text-white" data-filter="INTEGERS">Mixed Integers</button>
        </div>

        <h3 id="leaderboardTitle" class="text-base sm:text-lg font-bold text-blue-400 mb-2 border-b border-blue-400/50">Top Dashers (Overall)</h3>
        <div id="leaderboard" class="text-xs sm:text-sm">
            <div class="leaderboard-item font-bold text-gray-400">
                <span>#</span>
                <span>Player</span>
                <span>Score</span>
            </div>
            <div id="leaderboardList">
                <p class="text-center py-2 text-gray-500">Loading scores...</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Firebase Setup ---
    let app, db, auth, userId = null;
    let userSurname = ""; 
    let userSection = ""; 
    let identityLocked = false; 
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    const PUBLIC_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDRmaI9bZXdQ_IQDV-AfLb0cHxTQx15DJc",
        authDomain: "math-dash-f377d.firebaseapp.com",
        projectId: "math-dash-f377d",
        storageBucket: "math-dash-f377d.firebasestorage.app",
        messagingSenderId: "96602470442",
        appId: "1:96602470442:web:55cd87dd1bb0ed032e2b53",
        measurementId: "G-50YS8K8BQM"
    };
    
    let firebaseConfig = null;
    try {
        firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : PUBLIC_FIREBASE_CONFIG;
    } catch (e) {
        firebaseConfig = PUBLIC_FIREBASE_CONFIG;
    }
    
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const SCORE_COLLECTION_PATH = `artifacts/${appId}/public/data/math_dash_scores`;
    let attempts = 0;
    const MAX_ATTEMPTS = 5;

    // Constants and Game Configuration
    const CANVAS = document.getElementById('gameCanvas');
    const CTX = CANVAS.getContext('2d');
    const CANVAS_WRAPPER = document.getElementById('canvas-wrapper');
    const QUESTION_DISPLAY = document.getElementById('questionDisplay');
    const ANSWER_INPUT = document.getElementById('answerInput');
    const FEEDBACK = document.getElementById('feedback');
    const SCORE_ELEM = document.getElementById('score');
    const TIME_ELEM = document.getElementById('time');
    const DISTANCE_ELEM = document.getElementById('distance');
    const SUBMIT_BUTTON = document.getElementById('submitButton');
    const GAME_OVER_MODAL = document.getElementById('gameOverModal');
    const RESTART_BUTTON = document.getElementById('restartButton');
    const BACK_TO_MENU_BUTTON = document.getElementById('backToMenuButton');
    const USER_ID_DISPLAY = document.getElementById('userIdDisplay');
    const USER_ID_CONTAINER = document.getElementById('userIdContainer');
    const COPY_FEEDBACK = document.getElementById('copyFeedback');
    const COPY_ICON = document.getElementById('copyIcon');
    const LEADERBOARD_LIST = document.getElementById('leaderboardList');
    const LEADERBOARD_TITLE = document.getElementById('leaderboardTitle');
    const MENU_SCREEN = document.getElementById('menuScreen');
    const GAME_SCREEN = document.getElementById('gameScreen');
    const USER_INPUT_SCREEN = document.getElementById('userInputScreen');
    const SURNAME_INPUT = document.getElementById('surnameInput'); 
    const YEAR_SECTION_SELECT = document.getElementById('yearSectionSelect');
    const SIGN_IN_BUTTON = document.getElementById('signInButton');
    const AUTH_MESSAGE = document.getElementById('authMessage');
    const FILTER_BUTTONS = document.querySelectorAll('.leaderboard-filter-btn');
    
    const HOME_SCREEN = document.getElementById('homeScreen');
    const PLAY_BUTTON = document.getElementById('playButton');
    const QUIT_BUTTON = document.getElementById('quitButton');
    const LEADERBOARD_SECTION = document.getElementById('leaderboardSection'); 
    const HOME_HEADER = document.getElementById('homeHeader'); 

    // Game State
    let gameState = {
        isRunning: false,
        score: 0,
        time: 0,
        distance: 0,
        question: null,
        correctAnswer: null,
        mode: null,
        baseCarSpeed: 2,
        dashSpeed: 10,
        currentCarSpeed: 2,
        maxNumber: 10,
        laneOffset: 0,
        laneLineLength: 50,
        laneGap: 70,
        feedbackTimer: null,
        gameInterval: null,
        timeLimit: 60,
        isAuthReady: false,
        canvasWidth: 400,
        canvasHeight: 400,
        shakeOffset: 0,
        shakeIntensity: 5,
        flashOpacity: 0,
        currentFilter: 'OVERALL', 
        bgImage: null,
        bgImageLoaded: false,
        bgImageY: 0,
        competitors: [] 
    };

    let unsubscribeCompetitors = null;
    
    function getHighscoreDocId(mode, uid) {
        if (mode === 'OVERALL' || mode === 'MY_SECTION') {
            return uid;
        }
        return `${uid}_${mode}`;
    }

    function startCompetitorListener() {
        if (!db || !gameState.mode) return;
        
        if (unsubscribeCompetitors) {
            unsubscribeCompetitors();
        }

        const mode = gameState.mode;
        const competitorsQuery = query(
            collection(db, SCORE_COLLECTION_PATH),
            where("mode", "==", mode),
            orderBy("score", "desc"), 
            limit(5) 
        );

        unsubscribeCompetitors = onSnapshot(competitorsQuery, (snapshot) => {
            let topCompetitors = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId && data.userId !== userId) {
                    topCompetitors.push({
                        userSurname: `${data.userSurname || ''}`, 
                        distance: data.distance || 0,
                        score: data.score || 0, 
                        userId: data.userId
                    });
                }
            });
            topCompetitors.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return b.distance - a.distance;
            });
            
            gameState.competitors = topCompetitors.slice(0, 4); 
        }, (error) => {
            console.error("Error fetching live competitors:", error);
        });
    }

    function stopCompetitorListener() {
        if (unsubscribeCompetitors) {
            unsubscribeCompetitors();
            unsubscribeCompetitors = null;
        }
        gameState.competitors = [];
    }

    // Load background image
    const backgroundImage = new Image();
    backgroundImage.onload = () => {
        gameState.bgImageLoaded = true;
        if (!gameState.isRunning) {
            drawStaticScreen();
        }
    };
    backgroundImage.onerror = () => {
        console.error("Failed to load background image.");
    };
    backgroundImage.src = './MRace/bg_image.jpg'; 

    function setView(view) {
        HOME_SCREEN.classList.add('hidden');
        USER_INPUT_SCREEN.classList.add('hidden');
        MENU_SCREEN.classList.add('hidden');
        GAME_SCREEN.classList.add('hidden');
        GAME_OVER_MODAL.classList.add('hidden');
        LEADERBOARD_SECTION.classList.add('hidden');
        
        if (view === 'home') {
            HOME_SCREEN.classList.remove('hidden');
            // Leaderboard stays hidden on home screen
        } else if (view === 'input') {
            USER_INPUT_SCREEN.classList.remove('hidden');
            LEADERBOARD_SECTION.classList.remove('hidden');
        } else if (view === 'menu') {
            MENU_SCREEN.classList.remove('hidden');
            LEADERBOARD_SECTION.classList.remove('hidden');
        } else if (view === 'game') {
            GAME_SCREEN.classList.remove('hidden');
            LEADERBOARD_SECTION.classList.remove('hidden');
        }
    }
    
    function showHome() {
        setView('home');
    }

    function lockIdentityUI() {
        SURNAME_INPUT.value = userSurname;
        YEAR_SECTION_SELECT.value = userSection;
        SURNAME_INPUT.disabled = true;
        YEAR_SECTION_SELECT.disabled = true;
        SIGN_IN_BUTTON.textContent = `CONTINUE AS ${userSurname.toUpperCase()}`;
        SIGN_IN_BUTTON.disabled = false;
        SIGN_IN_BUTTON.style.opacity = '1';
        
        AUTH_MESSAGE.textContent = "Ready to Dash!"; 
        AUTH_MESSAGE.style.color = "#8b949e";
        
        const mySectionBtn = document.querySelector('[data-filter="MY_SECTION"]');
        if (mySectionBtn) {
            mySectionBtn.textContent = userSection || 'My Section';
        }
    }

    /**
     * Validates user input fields and enables/disables the sign-in button
     */
    async function validateUserInput() {
        const inputSurname = SURNAME_INPUT.value.trim();
        const inputSection = YEAR_SECTION_SELECT.value;
        
        // Check if surname exists in database and auto-fill section
        if (inputSurname.length >= 2 && db && !identityLocked) {
            try {
                const scoresRef = collection(db, SCORE_COLLECTION_PATH);
                const surnameQuery = query(
                    scoresRef,
                    where("userSurname", "==", inputSurname),
                    where("isOverall", "==", true),
                    limit(1)
                );
                
                const snapshot = await getDocs(surnameQuery);
                
                if (!snapshot.empty) {
                    // Surname exists! Auto-fill the section
                    const existingUserData = snapshot.docs[0].data();
                    const existingSection = existingUserData.userSection;
                    
                    if (existingSection) {
                        YEAR_SECTION_SELECT.value = existingSection;
                        YEAR_SECTION_SELECT.disabled = true; // Lock the section dropdown
                        YEAR_SECTION_SELECT.classList.add('auto-detected'); // Add green border
                        
                        AUTH_MESSAGE.textContent = `Found: ${inputSurname} from ${existingSection}`;
                        AUTH_MESSAGE.style.color = "#3fb950"; // Green color
                        
                        SIGN_IN_BUTTON.disabled = false;
                        SIGN_IN_BUTTON.style.opacity = '1';
                        SIGN_IN_BUTTON.textContent = `CONTINUE AS ${inputSurname.toUpperCase()}`;
                        
                        return; // Exit early since we found existing user
                    }
                } else {
                    // Surname doesn't exist, remove auto-detected styling
                    YEAR_SECTION_SELECT.classList.remove('auto-detected');
                }
                
                // Surname doesn't exist, enable section selection
                YEAR_SECTION_SELECT.disabled = false;
                YEAR_SECTION_SELECT.querySelector('option[value=""]').textContent = "-- Select Your Section --";
                SIGN_IN_BUTTON.textContent = `START RACING`;
                
            } catch (error) {
                console.error("Error checking existing user:", error);
            }
        }
        
        // Enable Year and Section dropdown only if surname has at least 2 characters
        if (inputSurname.length >= 2 && YEAR_SECTION_SELECT.disabled && !identityLocked) {
            // Only enable if it wasn't already disabled due to existing user
            const selectedValue = YEAR_SECTION_SELECT.value;
            if (selectedValue === "") {
                YEAR_SECTION_SELECT.disabled = false;
                YEAR_SECTION_SELECT.classList.remove('auto-detected');
                YEAR_SECTION_SELECT.querySelector('option[value=""]').textContent = "-- Select Your Section --";
            }
        } else if (inputSurname.length < 2 && !identityLocked) {
            YEAR_SECTION_SELECT.disabled = true;
            YEAR_SECTION_SELECT.value = "";
            YEAR_SECTION_SELECT.classList.remove('auto-detected');
            YEAR_SECTION_SELECT.querySelector('option[value=""]').textContent = "-- Enter Surname First --";
        }
        
        // Enable button only if both fields are valid
        if (inputSection !== "" && inputSurname.length >= 2 && inputSurname.length <= 20) {
            SIGN_IN_BUTTON.disabled = false;
            SIGN_IN_BUTTON.style.opacity = '1';
            
            if (!identityLocked) {
                AUTH_MESSAGE.textContent = "Ready to start!";
                AUTH_MESSAGE.style.color = "#8b949e";
            }
        } else {
            if (!identityLocked) {
                SIGN_IN_BUTTON.disabled = true;
                SIGN_IN_BUTTON.style.opacity = '0.5';
                
                if (inputSurname.length >= 2 && inputSection === "" && !YEAR_SECTION_SELECT.disabled) {
                    AUTH_MESSAGE.textContent = "Please select your Year and Section.";
                    AUTH_MESSAGE.style.color = "#8b949e";
                } else if (inputSurname.length < 2) {
                    AUTH_MESSAGE.textContent = "Enter your surname to continue.";
                    AUTH_MESSAGE.style.color = "#8b949e";
                } else {
                    AUTH_MESSAGE.textContent = "Enter your information to play.";
                    AUTH_MESSAGE.style.color = "#8b949e";
                }
            }
        }
    }

    /**
     * Attempts to lookup existing user data by surname and section
     */
    async function lookupExistingUser(surname, section) {
        if (!db || !surname || !section) return null;
        
        try {
            const scoresRef = collection(db, SCORE_COLLECTION_PATH);
            const userQuery = query(
                scoresRef,
                where("userSurname", "==", surname),
                where("userSection", "==", section),
                where("isOverall", "==", true),
                limit(1)
            );
            
            const snapshot = await getDocs(userQuery);
            
            if (!snapshot.empty) {
                return snapshot.docs[0].data();
            }
        } catch (error) {
            console.error("Error looking up existing user:", error);
        }
        
        return null;
    }

    /**
     * Handles the sign-in/registration logic and saves identity to Firestore
     */
    async function handleSignIn() {
        if (identityLocked && userSection && userSurname) {
            AUTH_MESSAGE.textContent = `Welcome back, ${userSurname}!`;
            setView('menu');
            showMenu();
            return;
        }

        const inputSurname = SURNAME_INPUT.value.trim();
        const inputSection = YEAR_SECTION_SELECT.value;

        if (inputSection === "") {
            AUTH_MESSAGE.textContent = "Please select a Year and Section.";
            return;
        }
        
        if (inputSurname.length < 2 || inputSurname.length > 20) {
            AUTH_MESSAGE.textContent = "Surname must be 2-20 characters.";
            return;
        }

        userSurname = inputSurname;
        userSection = inputSection;
        identityLocked = true;

        localStorage.setItem('mathDashUserSurname', userSurname);
        localStorage.setItem('mathDashUserSection', userSection);
        
        if (db && userId) {
             try {
                const userDocRef = doc(db, 'users', userId); 
                await setDoc(userDocRef, {
                    userId: userId,
                    userSurname: userSurname,
                    userSection: userSection,
                    lastLogin: serverTimestamp()
                }, { merge: true });
                console.log("User identity saved to Firestore.");
            } catch (error) {
                console.error("Error saving user identity to Firestore:", error);
                AUTH_MESSAGE.textContent = "Error saving identity. Check Firebase Rules.";
            }
        }
        
        lockIdentityUI();
        
        if (gameState.currentFilter === 'MY_SECTION') {
            loadHighScores('MY_SECTION');
        }
        
        setView('menu');
        showMenu();
    }
    
    function showMenu() {
        setView('menu');
        gameState.isRunning = false;
        if (gameState.gameInterval) clearInterval(gameState.gameInterval);
        if (gameState.timeLimitInterval) clearInterval(gameState.timeLimitInterval);
        stopCompetitorListener(); 
        drawStaticScreen(); 
    }
    
    function quitProgram() {
        if (confirm("Are you sure you want to quit the game?")) {
            window.close();
            document.body.innerHTML = '<div style="font-family: Arial, sans-serif; text-align: center; color: white; padding-top: 50vh; transform: translateY(-50%); background-color: #0d1117; font-size: 24px;">Game has ended. Thank you for playing!</div>';
        }
    }

    /**
     * Checks Firestore for existing user identity based on userId
     */
    async function checkExistingUserIdentity(currentUserId) {
        if (!db || !currentUserId) return false;
        
        const userDocRef = doc(db, 'users', currentUserId);
        
        let data = null;
        try {
            const userDocSnap = await getDoc(userDocRef);
            
            if (userDocSnap.exists()) {
                data = userDocSnap.data();
            } else {
                const overallScoreRef = doc(db, SCORE_COLLECTION_PATH, currentUserId);
                const scoreDocSnap = await getDoc(overallScoreRef);
                
                if (scoreDocSnap.exists() && scoreDocSnap.data().isOverall) {
                    data = scoreDocSnap.data();
                }
            }
        } catch (error) {
            console.error("Error checking existing user identity in Firestore:", error);
            return false; 
        }
        
        if (data && data.userSurname && data.userSection) {
            userSurname = data.userSurname;
            userSection = data.userSection;
            identityLocked = true;
            localStorage.setItem('mathDashUserSurname', userSurname);
            localStorage.setItem('mathDashUserSection', userSection);
            lockIdentityUI();
            return true;
        }
        
        return false;
    }

    async function initFirebase() {
        // Check local storage first
        const storedSurname = localStorage.getItem('mathDashUserSurname');
        const storedSection = localStorage.getItem('mathDashUserSection');
        
        if (storedSurname && storedSection) {
            userSurname = storedSurname;
            userSection = storedSection;
            identityLocked = true;
            lockIdentityUI();
        } else {
            SIGN_IN_BUTTON.textContent = `START RACING`;
            SIGN_IN_BUTTON.disabled = true;
            SIGN_IN_BUTTON.style.opacity = '0.5';
            YEAR_SECTION_SELECT.disabled = true; // Disabled until surname is entered
            if(storedSurname) {
                SURNAME_INPUT.value = storedSurname;
                validateUserInput(); // This will enable section if surname is valid
            }
            if(storedSection) YEAR_SECTION_SELECT.value = storedSection;
        }

        if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error("Firebase config is missing or using placeholders. Scoreboard disabled.");
            USER_ID_DISPLAY.textContent = "OFFLINE MODE";
            AUTH_MESSAGE.textContent = "Running in Offline/Local Mode.";
            setView('home'); 
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            AUTH_MESSAGE.textContent = "Connecting to server...";

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    USER_ID_DISPLAY.textContent = userId;
                    gameState.isAuthReady = true;
                    
                    if (!identityLocked) {
                        AUTH_MESSAGE.textContent = "Checking for user data...";
                        const identityFound = await checkExistingUserIdentity(userId);
                        
                        if (identityFound) {
                            AUTH_MESSAGE.textContent = "User data found! Ready to Dash!";
                        } else {
                            AUTH_MESSAGE.textContent = "Enter your information to play.";
                            SURNAME_INPUT.disabled = false;
                            // YEAR_SECTION_SELECT will be enabled by validateUserInput when surname is entered
                        }
                    } else {
                        AUTH_MESSAGE.textContent = "Ready to Dash!";
                    }

                    loadHighScores(); 
                    const mySectionBtn = document.querySelector('[data-filter="MY_SECTION"]');
                    if (mySectionBtn) {
                        mySectionBtn.textContent = userSection || 'My Section';
                    }
                } else {
                    userId = null;
                    USER_ID_DISPLAY.textContent = "Unauthenticated";
                    gameState.isAuthReady = true;
                    AUTH_MESSAGE.textContent = "Authentication required.";
                    loadHighScores(); 
                }
            });

            const token = initialAuthToken || "";
            if (token && token !== "YOUR_INITIAL_AUTH_TOKEN") {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            setView('home'); 

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            USER_ID_DISPLAY.textContent = "Auth Error";
            AUTH_MESSAGE.textContent = "Error connecting to Firebase.";
            gameState.isAuthReady = true;
            setView('home'); 
        }
    }
    
    function copyUserIdToClipboard() {
        if (!userId || userId === "Loading..." || userId === "Auth Error") {
            return;
        }

        const tempInput = document.createElement('textarea');
        tempInput.value = userId;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand('copy');
            COPY_FEEDBACK.classList.remove('hidden');
            COPY_ICON.classList.add('hidden');
            setTimeout(() => {
                COPY_FEEDBACK.classList.add('hidden');
                COPY_ICON.classList.remove('hidden');
            }, 2000);
        } catch (err) {
            console.error('Could not copy text: ', err);
            alert("Copy failed. Your Firebase ID is: " + userId);
        } finally {
            document.body.removeChild(tempInput);
        }
    }

    async function saveScore(score, distance) {
        if (!gameState.isAuthReady || !db || !userId) {
            console.warn("Authentication not ready. Score not saved.");
            return;
        }
        
        if (!userSurname || !userSection) {
            console.warn("User Surname or Section missing. Score not saved.");
            return;
        }

        if (gameState.mode && gameState.mode !== 'OVERALL') {
            const modeDocId = getHighscoreDocId(gameState.mode, userId);
            const modeScoreRef = doc(db, SCORE_COLLECTION_PATH, modeDocId);
            
            const docSnap = await getDoc(modeScoreRef);
            const existingScore = docSnap.exists() ? docSnap.data().score : -1;

            if (score > existingScore) {
                try {
                    await setDoc(modeScoreRef, {
                        userId: userId,
                        userSurname: userSurname, 
                        userSection: userSection, 
                        score: score,
                        distance: parseFloat(distance.toFixed(1)),
                        mode: gameState.mode,
                        timestamp: serverTimestamp(),
                        isOverall: false 
                    });
                    console.log(`High score saved for mode: ${gameState.mode}!`);
                } catch (error) {
                    console.error(`Error saving mode high score:`, error);
                }
            }
        }
        
        const overallDocId = getHighscoreDocId('OVERALL', userId);
        const overallScoreRef = doc(db, SCORE_COLLECTION_PATH, overallDocId);
        
        const docSnap = await getDoc(overallScoreRef);
        const existingOverallScore = docSnap.exists() ? docSnap.data().score : -1;
        
        if (score > existingOverallScore) {
            try {
                await setDoc(overallScoreRef, {
                    userId: userId,
                    userSurname: userSurname, 
                    userSection: userSection, 
                    score: score,
                    distance: parseFloat(distance.toFixed(1)),
                    mode: 'OVERALL', 
                    timestamp: serverTimestamp(),
                    isOverall: true 
                });
                console.log("New Overall High Score saved!");
            } catch (error) {
                console.error("Error saving Overall high score:", error);
            }
        }
    }

    let unsubscribeLeaderboard = null;

    function loadHighScores(modeFilter = gameState.currentFilter) {
        if (!db) return;

        if (unsubscribeLeaderboard) {
            unsubscribeLeaderboard();
            unsubscribeLeaderboard = null;
        }

        if (modeFilter === 'MY_SECTION') {
            if (!userSection || userSection === "") {
                LEADERBOARD_TITLE.textContent = `Top Dashers (Section Not Set)`;
                LEADERBOARD_LIST.innerHTML = `<p class="text-center py-2 text-red-400">Please set your Year and Section to view this leaderboard.</p>`;
                return;
            }
            LEADERBOARD_TITLE.textContent = `Top Dashers (${userSection})`;
        } else if (modeFilter !== 'OVERALL') {
            LEADERBOARD_TITLE.textContent = `Top Dashers (${modeFilter})`;
        } else {
            LEADERBOARD_TITLE.textContent = `Top Dashers (Overall)`;
        }
        
        document.querySelectorAll('.leaderboard-filter-btn').forEach(btn => {
            btn.classList.remove('leaderboard-filter-active');
            if (btn.dataset.filter === modeFilter) {
                btn.classList.add('leaderboard-filter-active');
            }
        });

        let scoresQuery;
        
        if (modeFilter === 'MY_SECTION') {
            scoresQuery = query(
                collection(db, SCORE_COLLECTION_PATH),
                where("userSection", "==", userSection), 
                where("isOverall", "==", true), 
                orderBy("score", "desc"),
                limit(10)
            );
        } else if (modeFilter === 'OVERALL') {
            scoresQuery = query(
                collection(db, SCORE_COLLECTION_PATH),
                where("isOverall", "==", true),
                orderBy("score", "desc"),
                limit(10)
            );
        } else {
            scoresQuery = query(
                collection(db, SCORE_COLLECTION_PATH),
                where("mode", "==", modeFilter),
                orderBy("score", "desc"),
                limit(10)
            );
        }
        
        unsubscribeLeaderboard = onSnapshot(scoresQuery, (snapshot) => {
            attempts = 0; 
            let scores = [];
            snapshot.forEach(doc => {
                scores.push(doc.data());
            });

            scores.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return b.distance - a.distance;
            });

            renderLeaderboard(scores);
        }, (error) => {
            console.error("Error fetching leaderboard:", error);
            
            if (error.code === 'permission-denied' || error.code === 'failed-precondition') {
                if (attempts < MAX_ATTEMPTS) {
                    attempts++;
                    const delay = Math.pow(2, attempts) * 1000;
                    console.log(`Retrying leaderboard load in ${delay / 1000}s...`);
                    
                    if (unsubscribeLeaderboard) {
                        unsubscribeLeaderboard();
                        unsubscribeLeaderboard = null;
                    }

                    setTimeout(() => {
                        attempts = 0;
                        loadHighScores(modeFilter); 
                    }, delay);
                    
                    LEADERBOARD_LIST.innerHTML = `<p class="text-center py-2 text-yellow-400">Loading scores...</p>`;
                } else {
                    LEADERBOARD_LIST.innerHTML = `<p class="text-center py-2 text-red-400">Error loading scores.</p>`;
                }
            } else {
                LEADERBOARD_LIST.innerHTML = `<p class="text-center py-2 text-red-400">Error loading scores.</p>`;
            }
        });
    }

    function renderLeaderboard(scores) {
        LEADERBOARD_LIST.innerHTML = '';
        if (scores.length === 0) {
            LEADERBOARD_LIST.innerHTML = `<p class="text-center py-2 text-gray-500">No scores yet. Be the first!</p>`;
            return;
        }

        scores.forEach((data, index) => {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            // Check if this is the current user's score
            const isCurrentUser = data.userId === userId;
            
            const displayUser = `${data.userSurname || ''} (${data.userSection || 'N/A'})`;
            
            item.innerHTML = `
                <span class="text-yellow-400">${index + 1}</span>
                <span class="${isCurrentUser ? 'text-green-400 font-bold' : 'text-gray-300'}">${displayUser}${isCurrentUser ? ' ⭐' : ''}</span>
                <span class="font-bold text-green-400">${data.score}</span>
            `;
            LEADERBOARD_LIST.appendChild(item);
        });
    }

    function generateIntegerProblem(max, mode) {
        const range = Math.max(5, max);
        const useIntegers = (mode === 'INTEGERS'); 
        
        let ops;
        if (mode === 'INTEGERS') {
            ops = ['+', '-', '*', '/'];
        } else if (mode === 'ADDITION') {
            ops = ['+'];
        } else if (mode === 'SUBTRACTION') {
            ops = ['-'];
        } else if (mode === 'MULTIPLICATION') {
            ops = ['*'];
        } else if (mode === 'DIVISION') {
            ops = ['/'];
        } else {
            ops = ['+', '-', '*', '/'];
        }
        
        const op = ops[Math.floor(Math.random() * ops.length)];

        let num1, num2, answer, problem;

        do {
            if (useIntegers) {
                num1 = Math.floor(Math.random() * (2 * range + 1)) - range;
                num2 = Math.floor(Math.random() * (2 * range + 1)) - range;
            } else {
                num1 = Math.floor(Math.random() * range) + 1;
                num2 = Math.floor(Math.random() * range) + 1;
            }
            
            if (num1 === 0) num1 = 1;
            if (num2 === 0) num2 = 1;

            if (op === '+') {
                answer = num1 + num2;
                problem = `${num1} + ${num2}`;
            } else if (op === '-') {
                answer = num1 - num2;
                problem = `${num1} - ${num2}`;
            } else if (op === '*') {
                const m_range = Math.min(12, range);
                if (useIntegers) {
                    num1 = Math.floor(Math.random() * (2 * m_range + 1)) - m_range;
                    num2 = Math.floor(Math.random() * (2 * m_range + 1)) - m_range;
                } else {
                    num1 = Math.floor(Math.random() * m_range) + 1;
                    num2 = Math.floor(Math.random() * m_range) + 1;
                }
                if (num1 === 0) num1 = 1;
                if (num2 === 0) num2 = 1;
                answer = num1 * num2;
                problem = `${num1} × ${num2}`;
            } else if (op === '/') {
                const d_range = Math.min(10, range);
                
                if (useIntegers) {
                    let divisor = Math.floor(Math.random() * (2 * d_range + 1)) - d_range;
                    while (divisor === 0) {
                        divisor = Math.floor(Math.random() * (2 * d_range + 1)) - d_range;
                    }
                    answer = Math.floor(Math.random() * (2 * d_range + 1)) - d_range;
                    num1 = answer * divisor;
                    num2 = divisor;
                } else {
                    let divisor = Math.floor(Math.random() * d_range) + 1;
                    answer = Math.floor(Math.random() * d_range) + 1;
                    num1 = answer * divisor;
                    num2 = divisor;
                }
                
                problem = `${num1} ÷ ${num2}`;
            }
        } while (Math.abs(answer) > 100 || Math.abs(num1) > 100 || Math.abs(num2) > 100);

        return { problem: problem, answer: answer };
    }

    function draw() {
        if (!gameState.isRunning) {
            drawStaticScreen();
            return;
        }
        
        const W = CANVAS.width;
        const H = CANVAS.height;

        const shakeX = gameState.shakeOffset > 0 ? (Math.random() * gameState.shakeOffset * 2) - gameState.shakeOffset : 0;
        const shakeY = gameState.shakeOffset > 0 ? (Math.random() * gameState.shakeOffset * 2) - gameState.shakeOffset : 0;

        gameState.shakeOffset = Math.max(0, gameState.shakeOffset - 0.5); 
        
        CTX.clearRect(0, 0, W, H);

        if (backgroundImage.complete && gameState.bgImageLoaded) {
            const bgImageAspect = backgroundImage.height / backgroundImage.width;
            const bgImageH = W * bgImageAspect;
            
            CTX.drawImage(backgroundImage, 0, gameState.bgImageY, W, bgImageH);
            CTX.drawImage(backgroundImage, 0, gameState.bgImageY - bgImageH, W, bgImageH);

            gameState.bgImageY = (gameState.bgImageY + gameState.currentCarSpeed) % bgImageH;
        } else {
            CTX.fillStyle = '#30363d';
            CTX.fillRect(0, 0, W, H);
            
            CTX.fillStyle = '#ffffff'; 
            const centerLineX = W / 2 - (W * 0.0125); 
            const lineWidth = W * 0.025; 
            const lineOffset = gameState.laneOffset % (gameState.laneLineLength + gameState.laneGap);

            for (let y = -gameState.laneLineLength + lineOffset + shakeY; y < H + shakeY; y += (gameState.laneLineLength + gameState.laneGap)) {
                CTX.fillRect(centerLineX + shakeX, y, lineWidth, gameState.laneLineLength);
            }
            gameState.laneOffset += gameState.currentCarSpeed;
        }
        
        if (gameState.flashOpacity > 0) {
            CTX.fillStyle = `rgba(255, 255, 255, 0.7)`; 
            CTX.fillRect(0, 0, W, H);
            gameState.flashOpacity = Math.max(0, gameState.flashOpacity - 0.1); 
        }
        
        if (gameState.competitors.length > 0) {
            const enemyCarW = W * 0.08; 
            const enemyCarH = H * 0.07; 
            const laneOffsets = [W * 0.1, W * 0.35, W * 0.60, W * 0.85];

            gameState.competitors.forEach((competitor, index) => {
                const distDiff = competitor.distance - gameState.distance; 
                const yOffset = distDiff * 10; 

                let enemyY = H - (H * 0.3) - yOffset; 
                
                if (enemyY < -enemyCarH || enemyY > H) return;
                
                const enemyX = laneOffsets[index % laneOffsets.length] - enemyCarW / 2;

                const enemyDrawX = enemyX + shakeX * 0.2;
                const enemyDrawY = enemyY + shakeY * 0.2;

                CTX.fillStyle = '#f85149'; 
                CTX.fillRect(enemyDrawX, enemyDrawY, enemyCarW, enemyCarH);
                
                CTX.fillStyle = '#ffffff';
                CTX.font = `${Math.floor(W * 0.025)}px Chivo Mono`;
                CTX.textAlign = 'center';
                CTX.fillText(competitor.userSurname.substring(0, 5), enemyDrawX + enemyCarW / 2, enemyDrawY - 5);
            });
        }
        
        if (gameState.currentCarSpeed > gameState.baseCarSpeed * 1.5) {
            CTX.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            CTX.lineWidth = 2;
            
            for (let i = 0; i < 10; i++) {
                const lineX = Math.random() * W;
                const lineStart = Math.random() * H;
                const lineLength = gameState.currentCarSpeed * 3; 

                CTX.beginPath();
                CTX.moveTo(lineX, lineStart);
                CTX.lineTo(lineX, lineStart + lineLength);
                CTX.stroke();
            }
        }

        const carW = W * 0.10; 
        const carH = H * 0.175; 
        const carX = W / 2 - carW / 2;
        const carY = H - carH - (H * 0.075); 

        const carDrawX = carX + shakeX * 0.5;
        const carDrawY = carY + shakeY * 0.5;

        CTX.fillStyle = '#f9d22d';
        CTX.fillRect(carDrawX, carDrawY, carW, carH);
        CTX.fillStyle = '#0d1117';
        CTX.fillRect(carDrawX + carW * 0.1, carDrawY + carH * 0.2, carW * 0.8, carH * 0.5);
        CTX.fillStyle = '#ffffff';
        CTX.fillRect(carDrawX, carDrawY + carH - (H * 0.0125), carW * 0.25, H * 0.0125);
        CTX.fillRect(carDrawX + carW * 0.75, carDrawY + carH - (H * 0.0125), carW * 0.25, H * 0.0125);

        CTX.fillStyle = '#f85149';
        CTX.font = `${Math.floor(W * 0.045)}px Chivo Mono`;
        CTX.textAlign = 'center';
        CTX.fillText('#7', carDrawX + carW / 2, carDrawY + carH * 0.45);

        updateGamePhysics();
    }

    function drawStaticScreen() {
        const W = CANVAS.width;
        const H = CANVAS.height;
        
        CTX.clearRect(0, 0, W, H);

        if (backgroundImage.complete && gameState.bgImageLoaded) {
            const scale = Math.max(W / backgroundImage.width, H / backgroundImage.height);
            const x = (W / 2) - (backgroundImage.width / 2) * scale;
            const y = (H / 2) - (backgroundImage.height / 2) * scale;
            const width = backgroundImage.width * scale;
            const height = backgroundImage.height * scale;
            CTX.drawImage(backgroundImage, x, y, width, height);

            CTX.fillStyle = 'rgba(0, 30, 60, 0.4)'; 
            CTX.fillRect(0, 0, W, H);
        } else {
            CTX.fillStyle = '#161b22';
            CTX.fillRect(0, 0, W, H);
        }
        
        CTX.fillStyle = '#58a6ff';
        CTX.font = `${Math.floor(W * 0.075)}px Luckiest Guy`;
        CTX.textAlign = 'center';
        CTX.fillText('MATH DASH', W / 2, H / 2 - 20);

        CTX.fillStyle = '#c9d1d9';
        CTX.font = `${Math.floor(W * 0.04)}px Chivo Mono`;
        CTX.fillText('Select a mode to start racing!', W / 2, H / 2 + 20);
        
        if (userSurname && userSection) {
            CTX.fillText(`Player: ${userSurname} (${userSection})`, W / 2, H / 2 + 50);
        }
    }

    function updateGamePhysics() {
        if (!gameState.isRunning) return;
        
        gameState.distance += gameState.currentCarSpeed / 10;
        DISTANCE_ELEM.textContent = `${Math.floor(gameState.distance)} m`;

        gameState.currentCarSpeed = Math.max(gameState.baseCarSpeed, gameState.currentCarSpeed - 0.1); 
    }

    function startGame(mode) {
        if (!userSurname || !userSection) {
            alert("Please sign in with your Surname and Section first.");
            setView('input');
            return;
        }

        if (!mode) return showMenu();

        setView('game');
        GAME_OVER_MODAL.classList.add('hidden');
        
        gameState.isRunning = true;
        gameState.score = 0;
        gameState.time = 0;
        gameState.distance = 0;
        gameState.maxNumber = 10;
        gameState.mode = mode; 
        gameState.dashSpeed = 10; 
        gameState.currentCarSpeed = gameState.baseCarSpeed;
        gameState.shakeOffset = 0; 
        gameState.flashOpacity = 0; 
        gameState.bgImageY = 0; 
        
        SCORE_ELEM.textContent = gameState.score;
        TIME_ELEM.textContent = `${gameState.timeLimit}s`;
        DISTANCE_ELEM.textContent = `${Math.floor(gameState.distance)} m`;
        
        ANSWER_INPUT.value = '';
        FEEDBACK.textContent = '';
        SUBMIT_BUTTON.textContent = 'SUBMIT';
        SUBMIT_BUTTON.style.backgroundColor = '#58a6ff';
        SUBMIT_BUTTON.style.boxShadow = '0 4px #448ccf';

        if (gameState.gameInterval) clearInterval(gameState.gameInterval);
        
        gameState.gameInterval = setInterval(gameLoop, 1000 / 60);

        if (gameState.timeLimitInterval) clearInterval(gameState.timeLimitInterval);
        gameState.timeLimitInterval = setInterval(updateTime, 1000);

        newQuestion();
        startCompetitorListener(); 
    }

    function gameLoop() {
        if (!gameState.isRunning) return;
        draw();
    }

    function updateTime() {
        if (!gameState.isRunning) return;
        
        gameState.time++;
        const remainingTime = gameState.timeLimit - gameState.time;
        TIME_ELEM.textContent = `${remainingTime}s`;

        if (remainingTime <= 0) {
            endGame();
        }
    }

    function newQuestion() {
        if (gameState.score > 0 && gameState.score % 5 === 0) {
            gameState.maxNumber += 5; 
            if (gameState.maxNumber > 30) gameState.maxNumber = 30;
        }

        gameState.question = generateIntegerProblem(gameState.maxNumber, gameState.mode);
        gameState.correctAnswer = gameState.question.answer;
        QUESTION_DISPLAY.textContent = `${gameState.question.problem} = ?`;
        ANSWER_INPUT.value = '';
    }

    function checkAnswer() {
        if (!gameState.isRunning) {
            startGame(gameState.mode);
            return;
        }

        const userAnswer = parseInt(ANSWER_INPUT.value.trim());

        if (isNaN(userAnswer)) {
            showFeedback("Please enter a number.", 'incorrect-message');
            return;
        }

        if (userAnswer === gameState.correctAnswer) {
            gameState.currentCarSpeed = gameState.dashSpeed;
            gameState.shakeOffset = gameState.shakeIntensity; 
            gameState.flashOpacity = 1; 
            gameState.score++;
            SCORE_ELEM.textContent = gameState.score;
            showFeedback("CORRECT! DASH!", 'correct-message');
            newQuestion();
        } else {
            gameState.currentCarSpeed = Math.max(1, gameState.currentCarSpeed - 1);
            showFeedback("INCORRECT. Try again.", 'incorrect-message');
        }
        
        ANSWER_INPUT.value = '';
    }

    function showFeedback(message, className) {
        if (gameState.feedbackTimer) clearTimeout(gameState.feedbackTimer);
        FEEDBACK.className = `h-6 text-lg font-semibold ${className}`;
        FEEDBACK.textContent = message;

        gameState.feedbackTimer = setTimeout(() => {
            FEEDBACK.textContent = '';
        }, 1500);
    }

    function endGame() {
        gameState.isRunning = false;
        clearInterval(gameState.gameInterval);
        clearInterval(gameState.timeLimitInterval);
        
        saveScore(gameState.score, gameState.distance);
        stopCompetitorListener(); 
        
        document.getElementById('finalScore').textContent = gameState.score;
        document.getElementById('finalDistance').textContent = `${Math.floor(gameState.distance)} m`;

        GAME_OVER_MODAL.classList.remove('hidden');
        
        SUBMIT_BUTTON.textContent = 'START';
        SUBMIT_BUTTON.style.backgroundColor = '#3fb950';
        SUBMIT_BUTTON.style.boxShadow = '0 4px #2b8438';
        
        QUESTION_DISPLAY.textContent = 'Time\'s Up!';
        ANSWER_INPUT.value = '';
    }

    function resizeCanvas() {
        const width = CANVAS_WRAPPER.clientWidth;
        CANVAS.width = width;
        CANVAS.height = width;

        gameState.canvasWidth = width;
        gameState.canvasHeight = width;

        if (gameState.isRunning) {
            draw();
        } else if (!MENU_SCREEN.classList.contains('hidden')) {
             drawStaticScreen(); 
        }
    }

    function handleKeypadPress(event) {
        const key = event.target.dataset.key;
        if (!key) return;
        
        const input = ANSWER_INPUT;
        
        if (key === 'submit') {
            checkAnswer();
        } else if (key === 'backspace') {
            input.value = input.value.slice(0, -1);
        } else if (key === 'sign') {
            if (input.value.startsWith('-')) {
                input.value = input.value.substring(1);
            } else if (input.value.length > 0 && input.value !== '0') {
                input.value = '-' + input.value;
            }
        } else if (key >= '0' && key <= '9') {
            if (input.value.length < 6) {
                input.value += key;
            }
        }
    }

    window.onload = function() {
        initFirebase();
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
        
        // Event Listeners
        PLAY_BUTTON.addEventListener('click', () => setView('input'));
        QUIT_BUTTON.addEventListener('click', quitProgram);
        
        // Back to Home button
        const BACK_TO_HOME_BUTTON = document.getElementById('backToHomeButton');
        BACK_TO_HOME_BUTTON.addEventListener('click', () => {
            setView('home');
            showHome();
        });
        
        document.getElementById('keypad').addEventListener('click', handleKeypadPress);
        RESTART_BUTTON.addEventListener('click', () => startGame(gameState.mode));
        BACK_TO_MENU_BUTTON.addEventListener('click', showMenu);
        USER_ID_CONTAINER.addEventListener('click', copyUserIdToClipboard);
        SIGN_IN_BUTTON.addEventListener('click', handleSignIn);

        // Add input validation listeners
        SURNAME_INPUT.addEventListener('input', validateUserInput);
        YEAR_SECTION_SELECT.addEventListener('change', validateUserInput);

        [SURNAME_INPUT, YEAR_SECTION_SELECT].forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !SIGN_IN_BUTTON.disabled) {
                    handleSignIn();
                }
            });
        });

        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', (e) => {
                startGame(e.target.dataset.mode);
            });
        });
        
        document.querySelectorAll('.leaderboard-filter-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                gameState.currentFilter = filter;
                loadHighScores(filter);
            });
        });

        ANSWER_INPUT.addEventListener('keydown', (e) => {
            e.preventDefault();
            if (e.key === 'Enter') checkAnswer();
        });
    };

</script>
</body>
</html>